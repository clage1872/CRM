<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Administrador - Sistema CRM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/validaciones.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="dashboard-admin.html">
                <i class="bi bi-shield-check"></i> Sistema CRM - Admin
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <span class="navbar-text text-white me-3">
                            <i class="bi bi-person-badge"></i> <span id="nombreAdmin">Administrador</span>
                        </span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="btnCerrarSesion">
                            <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-3">
                <div class="list-group">
                    <a href="dashboard-admin.html" class="list-group-item list-group-item-action">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                    <a href="todos-incidentes.html" class="list-group-item list-group-item-action">
                        <i class="bi bi-list-task"></i> Todos los Incidentes
                    </a>
                    <a href="#" class="list-group-item list-group-item-action">
                        <i class="bi bi-people"></i> Clientes
                    </a>
                    <a href="#" class="list-group-item list-group-item-action">
                        <i class="bi bi-bar-chart"></i> Reportes
                    </a>
                    <a href="crear-admin.html" class="list-group-item list-group-item-action active">
                        <i class="bi bi-person-plus-fill"></i> Crear Administrador
                    </a>
                    <a href="#" class="list-group-item list-group-item-action">
                        <i class="bi bi-gear"></i> Configuración
                    </a>
                </div>
            </div>

            <div class="col-md-9">
                <div class="card shadow">
                    <div class="card-header bg-dark text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-person-plus-fill"></i> Crear Nuevo Administrador
                        </h4>
                    </div>
                    <div class="card-body p-5">
                        <div id="alertExito" class="alert alert-success alert-dismissible fade" role="alert">
                            <i class="bi bi-check-circle-fill"></i>
                            <span id="mensajeExito"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>

                        <div id="alertError" class="alert alert-danger alert-dismissible fade" role="alert">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <span id="mensajeError"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        
                        <form id="formRegistroAdmin" novalidate>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="nombre" class="form-label">Nombre</label>
                                    <input type="text" class="form-control" id="nombre" name="nombre" maxlength="100" required>
                                    <div class="invalid-feedback">El nombre es obligatorio.</div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="apellido" class="form-label">Apellido</label>
                                    <input type="text" class="form-control" id="apellido" name="apellido" maxlength="100" required>
                                    <div class="invalid-feedback">El apellido es obligatorio.</div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" name="email" maxlength="150" required>
                                    <div class="invalid-feedback">Ingrese un email válido.</div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="cuit" class="form-label">CUIT (sin guiones)</label>
                                    <input type="text" class="form-control" id="cuit" name="cuit" maxlength="11" placeholder="20123456789" required>
                                    <div class="invalid-feedback">El CUIT debe tener 11 dígitos numéricos.</div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="rol" class="form-label">Rol</label>
                                    <select class="form-select" id="rol" name="rol" required>
                                        <option value="">Seleccione un rol</option>
                                        <option value="admin">Administrador</option>
                                        <option value="superadmin">Super Administrador</option>
                                    </select>
                                    <div class="invalid-feedback">Debe seleccionar un rol.</div>
                                </div>

                                <div class="col-md-6 mb-3">
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="password" class="form-label">Contraseña</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="password" name="password" required>
                                        <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                            <i class="bi bi-eye" id="eyeIcon"></i>
                                        </button>
                                    </div>
                                    <div class="invalid-feedback">
                                        La contraseña debe tener mínimo 8 caracteres, incluyendo mayúsculas, minúsculas, números y caracteres especiales.
                                    </div>
                                    <div class="password-strength mt-2">
                                        <small class="text-muted">Requisitos de contraseña:</small>
                                        <ul class="password-requirements">
                                            <li id="req-length" class="requirement-item">
                                                <i class="bi bi-x-circle text-danger"></i> Mínimo 8 caracteres
                                            </li>
                                            <li id="req-uppercase" class="requirement-item">
                                                <i class="bi bi-x-circle text-danger"></i> Una letra mayúscula
                                            </li>
                                            <li id="req-lowercase" class="requirement-item">
                                                <i class="bi bi-x-circle text-danger"></i> Una letra minúscula
                                            </li>
                                            <li id="req-number" class="requirement-item">
                                                <i class="bi bi-x-circle text-danger"></i> Un número
                                            </li>
                                            <li id="req-special" class="requirement-item">
                                                <i class="bi bi-x-circle text-danger"></i> Un carácter especial
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="confirmarPassword" class="form-label">Confirmar Contraseña</label>
                                    <input type="password" class="form-control" id="confirmarPassword" name="confirmarPassword" required>
                                    <div class="invalid-feedback">Las contraseñas no coinciden.</div>
                                </div>
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                                <a href="dashboard-admin.html" class="btn btn-secondary">
                                    <i class="bi bi-x-circle"></i> Cancelar
                                </a>
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-check-circle"></i> Crear Administrador
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('formRegistroAdmin');
            const nombre = document.getElementById('nombre');
            const apellido = document.getElementById('apellido');
            const email = document.getElementById('email');
            const cuit = document.getElementById('cuit');
            const rol = document.getElementById('rol');
            const password = document.getElementById('password');
            const confirmarPassword = document.getElementById('confirmarPassword');
            const togglePasswordBtn = document.getElementById('togglePassword');
            
            cuit.addEventListener('input', function() {
                this.value = this.value.replace(/\D/g, '');
            });
            
            if (togglePasswordBtn) {
                togglePasswordBtn.addEventListener('click', function() {
                    const eyeIcon = document.getElementById('eyeIcon');
                    
                    if (password.type === 'password') {
                        password.type = 'text';
                        eyeIcon.classList.remove('bi-eye');
                        eyeIcon.classList.add('bi-eye-slash');
                    } else {
                        password.type = 'password';
                        eyeIcon.classList.remove('bi-eye-slash');
                        eyeIcon.classList.add('bi-eye');
                    }
                });
            }
            
            password.addEventListener('input', function() {
                validarPassword(this);
            });
            
            function validarPassword(campo) {
                const password = campo.value;
                
                const requisitos = {
                    length: password.length >= 8,
                    uppercase: /[A-Z]/.test(password),
                    lowercase: /[a-z]/.test(password),
                    number: /[0-9]/.test(password),
                    special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
                };
                
                actualizarRequisitoPassword('req-length', requisitos.length);
                actualizarRequisitoPassword('req-uppercase', requisitos.uppercase);
                actualizarRequisitoPassword('req-lowercase', requisitos.lowercase);
                actualizarRequisitoPassword('req-number', requisitos.number);
                actualizarRequisitoPassword('req-special', requisitos.special);
                
                const todosValidos = Object.values(requisitos).every(val => val === true);
                
                if (!todosValidos) {
                    campo.classList.add('is-invalid');
                    campo.classList.remove('is-valid');
                    return false;
                } else {
                    campo.classList.remove('is-invalid');
                    campo.classList.add('is-valid');
                    return true;
                }
            }
            
            function actualizarRequisitoPassword(elementId, cumple) {
                const elemento = document.getElementById(elementId);
                if (elemento) {
                    const icono = elemento.querySelector('i');
                    if (cumple) {
                        icono.className = 'bi bi-check-circle-fill text-success';
                        elemento.classList.add('requirement-met');
                        elemento.classList.remove('requirement-not-met');
                    } else {
                        icono.className = 'bi bi-x-circle text-danger';
                        elemento.classList.add('requirement-not-met');
                        elemento.classList.remove('requirement-met');
                    }
                }
            }
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (password.value !== confirmarPassword.value) {
                    mostrarError('Las contraseñas no coinciden');
                    return;
                }
                
                const formData = {
                    nombre: nombre.value,
                    apellido: apellido.value,
                    email: email.value,
                    cuit: cuit.value,
                    password: password.value,
                    rol: rol.value
                };
                
                const usuario = obtenerUsuarioActivo();
                
                if (!usuario || !usuario.token) {
                    alert('Sesión expirada. Por favor inicie sesión nuevamente.');
                    window.location.href = 'login.html';
                    return;
                }
                
                try {
                    const response = await fetch('http://localhost:3000/api/auth/registro-admin', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${usuario.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        mostrarExito('Administrador creado exitosamente');
                        form.reset();
                        
                        setTimeout(() => {
                            window.location.href = 'dashboard-admin.html';
                        }, 2000);
                    } else {
                        mostrarError(data.message || 'Error al crear el administrador');
                    }
                    
                } catch (error) {
                    console.error('Error:', error);
                    mostrarError('Error de conexión con el servidor');
                }
            });
            
            function mostrarExito(mensaje) {
                const alertExito = document.getElementById('alertExito');
                const mensajeExito = document.getElementById('mensajeExito');
                
                if (alertExito && mensajeExito) {
                    mensajeExito.textContent = mensaje;
                    alertExito.classList.add('show');
                    
                    setTimeout(() => {
                        alertExito.classList.remove('show');
                    }, 5000);
                }
            }
            
            function mostrarError(mensaje) {
                const alertError = document.getElementById('alertError');
                const mensajeError = document.getElementById('mensajeError');
                
                if (alertError && mensajeError) {
                    mensajeError.textContent = mensaje;
                    alertError.classList.add('show');
                    
                    setTimeout(() => {
                        alertError.classList.remove('show');
                    }, 5000);
                }
            }
        });
    </script>
</body>
</html>